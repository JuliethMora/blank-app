name: Build and publish Docker imagename: Build and push Docker image



on:on:

  push:  push:

    branches: [ main ]    branches: [ main ]



permissions:permissions:

  contents: read  contents: read

  packages: write  packages: write



jobs:jobs:

  build-and-push:  build:

    runs-on: ubuntu-latest    runs-on: ubuntu-latest

    steps:

    steps:      - name: Checkout repository

      - name: Checkout repository        uses: actions/checkout@v4

        uses: actions/checkout@v4

      - name: Set up QEMU

      - name: Set up QEMU        uses: docker/setup-qemu-action@v2

        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx

      - name: Set up Docker Buildx        uses: docker/setup-buildx-action@v2

        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry

      - name: Login to GitHub Container Registry        uses: docker/login-action@v2

        uses: docker/login-action@v2        with:

        with:          registry: ghcr.io

          registry: ghcr.io          username: ${{ github.actor }}

          username: ${{ github.actor }}          password: ${{ secrets.GITHUB_TOKEN }}

          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image to GHCR

      - name: Build and push        uses: docker/build-push-action@v5

        uses: docker/build-push-action@v5        with:

        with:          context: .

          context: .          file: ./Dockerfile

          file: ./Dockerfile          push: true

          push: true          tags: |

          tags: |            ghcr.io/${{ github.repository }}:latest

            ghcr.io/${{ github.repository }}:latest            ghcr.io/${{ github.repository }}:${{ github.sha }}

            ghcr.io/${{ github.repository }}:${{ github.sha }}

      - name: Trigger Render deploy

      - name: Trigger Render deploy (if secrets set)        if: ${{ secrets.RENDER_API_KEY && secrets.RENDER_SERVICE_ID }}

        run: |        run: |

          if [ -n "${{ secrets.RENDER_API_KEY }}" ] && [ -n "${{ secrets.RENDER_SERVICE_ID }}" ]; then          echo "Triggering Render deploy for service ${{ secrets.RENDER_SERVICE_ID }}"

            echo "Triggering Render deploy for service ${{ secrets.RENDER_SERVICE_ID }}"          curl -sS -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \

            curl -sS -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \            -H "Accept: application/json" \

              -H "Accept: application/json" \            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \

              -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \            -H "Content-Type: application/json" \

              -H "Content-Type: application/json" \            -d '{"clearCache":true}' \

              -d '{"clearCache":true}' \            || (echo "Render deploy trigger failed" && exit 1)

              || (echo "Render deploy trigger failed" && exit 1)name: Build and publish Docker image

          else

            echo "Render secrets not set; skipping deploy"on:

          fi  push:

    branches: [ main ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}
